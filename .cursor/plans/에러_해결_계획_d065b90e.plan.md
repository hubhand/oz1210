# Runtime TypeError 해결 계획

## 개요

Next.js 15.5.7 + React 19 환경에서 발생하는 "Cannot read properties of undefined (reading 'call')" 에러를 해결합니다. 이 에러는 React JSX runtime, Clerk telemetry, Next.js navigation, Next.js Link 모듈에서 발생하며, 주로 빌드 캐시 손상 또는 모듈 해상도 문제로 인해 발생합니다.

## 에러 원인 분석

### 발생 위치
1. React JSX runtime (`react-jsx-dev-runtime.development.js`)
2. Clerk telemetry (`@clerk/shared/dist/runtime/telemetry`)
3. Next.js navigation (`next/dist/api/navigation.js`)
4. Next.js Link (`next/dist/client/app-dir/link.js`)

### 가능한 원인
1. **빌드 캐시 손상**: `.next` 폴더의 캐시가 손상되어 모듈 해상도 실패
2. **HMR 문제**: Hot Module Replacement 중 모듈이 제대로 갱신되지 않음
3. **의존성 버전 충돌**: React 19와 Next.js 15.5.7 간 호환성 문제
4. **Clerk 통합 문제**: Clerk와 Next.js App Router 통합 시 모듈 로딩 문제
5. **Webpack 청크 분할 문제**: 이미 설정된 청크 분할이 일부 모듈을 잘못 분리

## 해결 방법

### 1. 에러 바운더리 개선 (`app/error.tsx`)

**작업 내용:**
- 현재 에러 바운더리에 모듈 해상도 에러 감지 추가
- "Cannot read properties of undefined" 에러 감지 및 처리

**구현 세부사항:**
- 에러 메시지에 "Cannot read properties of undefined" 포함 여부 확인
- 해당 에러 감지 시 캐시 정리 안내 및 자동 새로고침
- 사용자 친화적 에러 메시지 표시

**파일 경로:** `app/error.tsx`

**변경 사항:**
```typescript
// 기존 ChunkLoadError 감지에 추가
const isModuleResolutionError =
  error.message.includes("Cannot read properties of undefined") ||
  error.message.includes("reading 'call'");

if (isModuleResolutionError || isChunkError) {
  // 캐시 정리 안내 및 자동 새로고침
}
```

### 2. Global Error Boundary 생성 (`app/global-error.tsx`)

**작업 내용:**
- 루트 레벨 에러 바운더리 생성
- 레이아웃 에러까지 처리

**구현 세부사항:**
- `app/global-error.tsx` 파일 생성
- 레이아웃 레벨 에러 처리
- 모듈 해상도 에러 감지 및 처리

**파일 경로:** `app/global-error.tsx` (새 파일)

**구현 코드:**
```typescript
"use client";

import { useEffect } from "react";
import { Button } from "@/components/ui/button";

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    const isModuleError =
      error.message.includes("Cannot read properties of undefined") ||
      error.message.includes("reading 'call'");

    if (isModuleError) {
      console.error("Module resolution error detected:", error);
      // 자동 새로고침 (5초 후)
      const timer = setTimeout(() => {
        window.location.reload();
      }, 5000);
      return () => clearTimeout(timer);
    }
  }, [error]);

  const isModuleError =
    error.message.includes("Cannot read properties of undefined") ||
    error.message.includes("reading 'call'");

  return (
    <html lang="ko">
      <body>
        <div className="flex flex-col items-center justify-center min-h-screen p-4">
          <h2 className="text-2xl font-bold mb-4">시스템 오류가 발생했습니다</h2>
          <p className="text-muted-foreground mb-4 text-center max-w-md">
            {isModuleError
              ? "모듈 로딩 중 문제가 발생했습니다. 페이지를 새로고침하거나 개발 서버를 재시작해주세요."
              : error.message || "예상치 못한 오류가 발생했습니다."}
          </p>
          {isModuleError && (
            <div className="text-sm text-muted-foreground mb-4 space-y-2">
              <p>해결 방법:</p>
              <ol className="list-decimal list-inside space-y-1">
                <li>브라우저를 새로고침하세요 (Ctrl+Shift+R)</li>
                <li>개발 서버를 재시작하세요 (pnpm dev:clean)</li>
                <li>브라우저 캐시를 삭제하세요</li>
              </ol>
            </div>
          )}
          <div className="flex gap-2">
            <Button onClick={reset} variant="default">
              다시 시도
            </Button>
            <Button
              onClick={() => window.location.reload()}
              variant="outline"
            >
              새로고침
            </Button>
          </div>
        </div>
      </body>
    </html>
  );
}
```

### 3. Next.js 설정 개선 (`next.config.ts`)

**작업 내용:**
- 모듈 해상도 개선
- 개발 환경 안정성 향상
- Clerk 모듈 로딩 최적화

**구현 세부사항:**
- `resolve.fallback` 설정 추가 (필요 시)
- 개발 환경에서 모듈 해상도 타임아웃 증가
- Clerk 모듈 로딩 최적화

**파일 경로:** `next.config.ts`

**변경 사항:**
```typescript
webpack: (config, { isServer, dev }) => {
  // 기존 설정 유지...
  
  // 개발 환경 모듈 해상도 개선
  if (dev) {
    config.resolve = {
      ...config.resolve,
      // 모듈 해상도 타임아웃 증가
      cache: false, // 개발 중 캐시 비활성화로 최신 모듈 보장
    };
    
    // 모듈 로딩 최적화
    config.optimization = {
      ...config.optimization,
      removeAvailableModules: false,
      removeEmptyChunks: false,
    };
  }
  
  return config;
},
```

### 4. 개발 스크립트 개선 (`package.json`)

**작업 내용:**
- 캐시 정리 스크립트 개선
- 더 강력한 정리 옵션 추가

**구현 세부사항:**
- `dev:clean` 스크립트에 node_modules 캐시 정리 추가 (선택 사항)
- `clean:all` 스크립트 추가 (완전 정리)

**파일 경로:** `package.json`

**변경 사항:**
```json
{
  "scripts": {
    "dev": "next dev",
    "dev:clean": "rimraf .next && next dev",
    "clean": "rimraf .next",
    "clean:all": "rimraf .next node_modules/.cache",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  }
}
```

### 5. 에러 로깅 개선

**작업 내용:**
- 개발 환경에서 상세한 에러 로깅
- 에러 발생 시점 추적

**구현 세부사항:**
- `app/error.tsx`와 `app/global-error.tsx`에 상세 로깅 추가
- 에러 스택 트레이스 출력
- 브라우저 콘솔에 디버깅 정보 표시

**파일 경로:** `app/error.tsx`, `app/global-error.tsx`

### 6. Clerk Provider 안정성 개선 (선택 사항)

**작업 내용:**
- ClerkProvider에 에러 바운더리 추가
- Clerk 모듈 로딩 실패 시 대체 UI 표시

**구현 세부사항:**
- ClerkProvider를 ErrorBoundary로 감싸기
- Clerk 로딩 실패 시 기본 레이아웃 표시

**파일 경로:** `app/layout.tsx`

**참고:**
- 이 작업은 선택 사항이며, 문제가 지속될 경우에만 구현

## 우선순위

1. **높음**: 에러 바운더리 개선 (`app/error.tsx`)
2. **높음**: Global Error Boundary 생성 (`app/global-error.tsx`)
3. **중간**: Next.js 설정 개선 (`next.config.ts`)
4. **중간**: 개발 스크립트 개선 (`package.json`)
5. **낮음**: 에러 로깅 개선
6. **낮음**: Clerk Provider 안정성 개선

## 테스트 체크리스트

1. **에러 바운더리 테스트**
   - [ ] 모듈 해상도 에러 발생 시 에러 바운더리가 작동하는지 확인
   - [ ] 에러 메시지가 사용자에게 명확하게 표시되는지 확인
   - [ ] 자동 새로고침이 작동하는지 확인

2. **Global Error Boundary 테스트**
   - [ ] 레이아웃 레벨 에러가 처리되는지 확인
   - [ ] 에러 발생 시 기본 HTML 구조가 유지되는지 확인

3. **개발 환경 안정성 테스트**
   - [ ] 개발 서버 재시작 후 에러가 재발하지 않는지 확인
   - [ ] 파일 변경 후 HMR이 정상 작동하는지 확인
   - [ ] 캐시 정리 후 정상 작동하는지 확인

## 예방 조치

1. **정기적인 캐시 정리**
   - 개발 중 주기적으로 `pnpm clean` 실행
   - 에러 발생 시 즉시 `pnpm dev:clean` 실행

2. **의존성 버전 관리**
   - React 19와 Next.js 15.5.7 호환성 확인
   - Clerk 버전 호환성 확인

3. **개발 환경 모니터링**
   - 브라우저 콘솔 에러 모니터링
   - 개발 서버 로그 확인

## 파일 변경 사항

### 새로 생성할 파일
1. `app/global-error.tsx`
   - 루트 레벨 에러 바운더리

### 수정할 파일
1. `app/error.tsx`
   - 모듈 해상도 에러 감지 추가
   - 에러 메시지 개선

2. `next.config.ts`
   - 개발 환경 모듈 해상도 개선
   - 모듈 로딩 최적화

3. `package.json`
   - 개발 스크립트 개선

### 검토할 파일
1. `app/layout.tsx`
   - ClerkProvider 안정성 확인 (필요 시 수정)

## 참고 사항

- 이 에러는 주로 개발 환경에서 발생하며, 프로덕션 빌드에서는 발생하지 않을 수 있음
- 빌드 캐시 정리가 가장 효과적인 해결 방법
- 문제가 지속될 경우 의존성 재설치 고려 (`rm -rf node_modules && pnpm install`)

